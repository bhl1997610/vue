

module.exports = function (req, res, boxUrl, appId, serverUrl, serverPort, appkey) {
    const BoxApp = require('../src/boxApp.js');
    let myBoxApp = new BoxApp('http://test.box.imeete.com', appId, appkey);

    function checkRoute(ticket, req, resolve){
        myBoxApp.auth_verify(ticket).then((data) => {
            if (data.code === 20000) {
                delete req.session.ticket;
                res.redirect('http://'+boxUrl+'/auth/login?advance=1&appid='+appId+'&redirect=http://'+serverUrl+':'+serverPort);
            } 
            if (data.code == 0) {
                req.session.ticket = data.data.app_token;
                if(req.url.indexOf('ticket') > -1) {
                    res.redirect('/')
                } else {
                    resolve()
                }
            }
        }, (error) => {
            reject('换票失败:' + error);
        });
    }
    return new Promise((resolve, reject) => {
        if (!req.session.ticket) {
            if(req.url.indexOf('ticket') > -1){
                checkRoute(req.url.split('=')[1], req, resolve, reject)
            }else{
                res.redirect('http://'+boxUrl+'/auth/login?advance=1&appid='+appId+'&redirect=http://'+serverUrl+':'+serverPort);
            }
        } else {
            checkRoute(req.session.ticket, req, resolve, reject)
        }
    })
};
